<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qi-Time Chronoacupuncture Calculator</title>
    <style>
        /* Import traditional serif fonts for authentic appearance */
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Cinzel:wght@400;500;600&display=swap');
        
        /* Reset all default margins and padding */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Main body styling with traditional Chinese color palette */
        body {
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #1a252f 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }

        /* Main container with elegant styling */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: linear-gradient(145deg, #f8f9fa, #ffffff);
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15), 0 0 0 1px rgba(52, 73, 94, 0.1);
            overflow: hidden;
            border: 1px solid #d4af37; /* Traditional gold accent */
        }

        /* Header section with animated background */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #d4af37;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        /* Animated qi energy background pattern */
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(212, 175, 55, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(212, 175, 55, 0.1) 0%, transparent 50%);
            animation: rotate 20s linear infinite;
        }

        /* Rotation animation for qi energy pattern */
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Main title styling */
        .header h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* Subtitle styling */
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
            font-style: italic;
        }

        /* Main content area styling */
        .main-content {
            padding: 40px;
            background: #fefefe;
        }

        /* Individual section containers */
        .qi-section {
            background: linear-gradient(145deg, #f8f9fa, #ffffff);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #d4af37;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        /* Section title styling */
        .section-title {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.4rem;
            font-family: 'Cinzel', serif;
            font-weight: 500;
            border-bottom: 2px solid #d4af37;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Constitutional type selection buttons container */
        .constitution-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        /* Individual constitution button styling */
        .constitution-btn {
            padding: 12px 20px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            background: linear-gradient(145deg, #ecf0f1, #ffffff);
            color: #34495e;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Cinzel', serif;
            font-weight: 500;
        }

        /* Active constitution button styling */
        .constitution-btn.active {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #d4af37;
            border-color: #d4af37;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 73, 94, 0.3);
        }

        /* Qi field visualization container */
        .qi-field-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: radial-gradient(circle at center, #1a252f 0%, #2c3e50 100%);
            border-radius: 12px;
            overflow: hidden;
            margin: 25px 0;
            border: 2px solid #d4af37;
        }

        /* Central qi field energy visualization */
        .qi-field {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(
                circle at center,
                rgba(212, 175, 55, 0.8) 0%,
                rgba(212, 175, 55, 0.4) 30%,
                rgba(212, 175, 55, 0.2) 60%,
                transparent 100%
            );
            animation: qiPulse 3s ease-in-out infinite;
        }

        /* First qi ripple effect */
        .qi-field::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            bottom: -20px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 50%;
            animation: qiRipple 4s ease-in-out infinite;
        }

        /* Second qi ripple effect */
        .qi-field::after {
            content: '';
            position: absolute;
            top: -40px;
            left: -40px;
            right: -40px;
            bottom: -40px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 50%;
            animation: qiRipple 4s ease-in-out infinite 1s;
        }

        /* Qi field pulsing animation */
        @keyframes qiPulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
            }
        }

        /* Qi ripple animation */
        @keyframes qiRipple {
            0% { 
                transform: scale(1);
                opacity: 0.6;
            }
            50% { 
                transform: scale(1.2);
                opacity: 0.3;
            }
            100% { 
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* Qi strength indicator overlay */
        .qi-strength-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: #d4af37;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-weight: 600;
        }

        /* Grid layout for optimal time cards */
        .optimal-times {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        /* Individual time card styling */
        .time-card {
            background: linear-gradient(145deg, #e3f2fd, #f8fdff);
            border: 2px solid #3498db;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        /* Time card hover effect */
        .time-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.2);
        }

        /* Peak time card special styling */
        .time-card.peak {
            background: linear-gradient(145deg, #e8f5e8, #f0fff4);
            border-color: #27ae60;
        }

        /* Peak time card hover effect */
        .time-card.peak:hover {
            box-shadow: 0 10px 30px rgba(39, 174, 96, 0.3);
        }

        /* Time slot text styling */
        .time-slot {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        /* Qi level indicator styling */
        .qi-level {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 12px;
        }

        /* Time description text styling */
        .time-description {
            font-style: italic;
            color: #555;
            font-size: 0.9rem;
        }

        /* Button styling */
        .btn {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #d4af37;
            border: 2px solid #d4af37;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Cinzel', serif;
            transition: all 0.3s ease;
            margin: 10px 5px 10px 0;
        }

        /* Button hover effect */
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 73, 94, 0.3);
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        }

        /* Lunar indicator display box */
        .lunar-indicator {
            background: linear-gradient(145deg, #2c3e50, #34495e);
            color: #d4af37;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid #d4af37;
        }

        /* Warning message box */
        .warning-box {
            background: linear-gradient(145deg, #fff3e0, #fdf8f0);
            border: 2px solid #f39c12;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #e67e22;
        }

        /* Methodology explanation box */
        .methodology-box {
            background: linear-gradient(145deg, #e8f5e8, #f0fff4);
            border: 2px solid #27ae60;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #2c3e50;
        }

        /* Sexagenary cycle display box */
        .sexagenary-display {
            background: rgba(0,0,0,0.1);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: 'Cinzel', serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER SECTION -->
        <div class="header">
            <h1>氣時計算器</h1> <!-- Chinese characters for "Qi Time Calculator" -->
            <h2 style="font-family: 'Cinzel', serif; font-size: 1.8rem; margin: 10px 0;">Qi-Time Chronoacupuncture Calculator</h2>
            <p>Traditional Chinese Medical Timing System Based on Zi Wu Liu Zhu Principles</p>
        </div>

        <div class="main-content">
            <!-- SCIENTIFIC FOUNDATION EXPLANATION -->
            <div class="qi-section">
                <h3 class="section-title">Scientific Foundation</h3>
                <div class="methodology-box">
                    <h4 style="margin-bottom: 15px; color: #27ae60;">Authentic Traditional Calculations</h4>
                    <p style="margin-bottom: 15px;">
                        This calculator implements authentic <strong>Zi Wu Liu Zhu (子午流注)</strong> chronoacupuncture principles 
                        as documented in peer-reviewed research (Slopek & Feng, 2009, Journal of Acupuncture and Tuina Science).
                    </p>
                    <p style="margin-bottom: 15px;">
                        <strong>Traditional Chinese Astronomical Methods Used:</strong>
                    </p>
                    <ul style="margin-left: 20px; line-height: 1.6;">
                        <li><strong>Sexagenary Cycle (干支):</strong> 60-day cycle of Heavenly Stems and Earthly Branches for precise timing</li>
                        <li><strong>Constitutional Organ Timing:</strong> Peak qi flow periods based on TCM meridian clock theory</li>
                        <li><strong>Lunar Month Calculations:</strong> Traditional Chinese lunar calendar methods (29.530593-day synodic month)</li>
                        <li><strong>Solar Chronobiology:</strong> "Morning light puts inner clock forward, evening light backwards" (research-verified)</li>
                        <li><strong>Cosmic Cycle Influence:</strong> 60-day cosmic energy patterns affecting qi field strength</li>
                    </ul>
                    <p style="margin-top: 15px; font-style: italic;">
                        Clinical research shows up to 20x greater therapeutic effectiveness when acupuncture timing follows these traditional principles.
                    </p>
                </div>
            </div>

            <!-- EDUCATIONAL EXPLANATION SECTION -->
            <div class="qi-section">
                <h3 class="section-title">Understanding Traditional Chinese Time System</h3>
                <div class="methodology-box">
                    <h4 style="margin-bottom: 15px; color: #27ae60;">What is the Sexagenary Cycle?</h4>
                    <p style="margin-bottom: 15px;">
                        The <strong>Sexagenary Cycle (六十甲子)</strong> is a 60-day cycle that has run continuously in China for over 3,000 years. 
                        Every day gets a unique combination of a <strong>Heavenly Stem</strong> + <strong>Earthly Branch</strong>.
                    </p>
                    
                    <h4 style="margin-bottom: 10px; color: #27ae60;">Heavenly Stems (天干) - Cosmic Influences:</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div>甲 (jiǎ) = Yang Wood</div>
                        <div>乙 (yǐ) = Yin Wood</div>
                        <div>丙 (bǐng) = Yang Fire</div>
                        <div>丁 (dīng) = Yin Fire</div>
                        <div>戊 (wù) = Yang Earth</div>
                        <div>己 (jǐ) = Yin Earth</div>
                        <div>庚 (gēng) = Yang Metal</div>
                        <div>辛 (xīn) = Yin Metal</div>
                        <div>壬 (rén) = Yang Water</div>
                        <div>癸 (guǐ) = Yin Water</div>
                    </div>
                    
                    <h4 style="margin-bottom: 10px; color: #27ae60;">Earthly Branches (地支) - Time & Animal Influences:</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div>子 (zǐ) = Rat (11 PM-1 AM)</div>
                        <div>丑 (chǒu) = Ox (1-3 AM)</div>
                        <div>寅 (yín) = Tiger (3-5 AM)</div>
                        <div>卯 (mǎo) = Rabbit (5-7 AM)</div>
                        <div>辰 (chén) = Dragon (7-9 AM)</div>
                        <div>巳 (sì) = Snake (9-11 AM)</div>
                        <div>午 (wǔ) = Horse (11 AM-1 PM)</div>
                        <div>未 (wèi) = Goat (1-3 PM)</div>
                        <div>申 (shēn) = Monkey (3-5 PM)</div>
                        <div>酉 (yǒu) = Rooster (5-7 PM)</div>
                        <div>戌 (xū) = Dog (7-9 PM)</div>
                        <div>亥 (hài) = Pig (9-11 PM)</div>
                    </div>
                    
                    <h4 style="margin-bottom: 10px; color: #27ae60;">What Makes a Day "Favorable"?</h4>
                    <p style="margin-bottom: 10px;">A day is favorable when the Earthly Branch matches your constitutional element:</p>
                    <ul style="margin-left: 20px; line-height: 1.6;">
                        <li><strong>Wood Constitution:</strong> Favorable on Rat, Ox, Tiger days (子丑寅)</li>
                        <li><strong>Fire Constitution:</strong> Favorable on Horse, Goat days (午未)</li>
                        <li><strong>Earth Constitution:</strong> Favorable on Dragon, Snake, Monkey, Dog days (辰巳申戌)</li>
                        <li><strong>Metal Constitution:</strong> Favorable on Tiger, Rabbit days (寅卯)</li>
                        <li><strong>Water Constitution:</strong> Favorable on Monkey, Rooster days (申酉)</li>
                    </ul>
                    <p style="margin-top: 15px; font-style: italic;">
                        On favorable days, your constitutional qi receives a 30% natural boost, making treatments more effective.
                    </p>
                </div>
            </div>
            <div class="qi-section">
                <h3 class="section-title">Constitutional Qi Type Selection</h3>
                <p style="margin-bottom: 20px; font-style: italic;">Select your primary constitutional type to calculate optimal qi flow times:</p>
                
                <div class="constitution-selector">
                    <!-- Five Element constitutional buttons -->
                    <div class="constitution-btn" data-element="Wood" onclick="selectConstitution('Wood')">
                        Wood (Liver/Gallbladder)
                    </div>
                    <div class="constitution-btn" data-element="Fire" onclick="selectConstitution('Fire')">
                        Fire (Heart/Small Intestine)
                    </div>
                    <div class="constitution-btn" data-element="Earth" onclick="selectConstitution('Earth')">
                        Earth (Spleen/Stomach)
                    </div>
                    <div class="constitution-btn" data-element="Metal" onclick="selectConstitution('Metal')">
                        Metal (Lung/Large Intestine)
                    </div>
                    <div class="constitution-btn" data-element="Water" onclick="selectConstitution('Water')">
                        Water (Kidney/Bladder)
                    </div>
                </div>
            </div>

            <!-- REAL-TIME QI FIELD VISUALIZATION -->
            <div class="qi-section">
                <h3 class="section-title">Real-Time Qi Electromagnetic Field</h3>
                <p style="margin-bottom: 15px; font-style: italic;">
                    Live visualization of bio-electromagnetic qi field strength for <span id="selectedElement">Wood</span> constitution based on traditional astronomical calculations:
                </p>
                
                <!-- Sexagenary cycle information display with educational tooltips -->
                <div class="sexagenary-display">
                    <strong>Sexagenary Day:</strong> <span id="sexagenaryDay">Loading...</span> | 
                    <strong>Heavenly Stem:</strong> <span id="heavenlyStem">--</span> <span id="stemMeaning" style="font-size: 0.9em; color: #666;">(Cosmic Influence)</span> | 
                    <strong>Earthly Branch:</strong> <span id="earthlyBranch">--</span> <span id="branchMeaning" style="font-size: 0.9em; color: #666;">(Time Animal)</span><br>
                    <strong>Favorable Day:</strong> <span id="favorableDay">Calculating...</span> <span id="favorableExplanation" style="font-size: 0.9em; color: #666;"></span> | 
                    <strong>Organ Peak Time:</strong> <span id="organPeakTime">Calculating...</span>
                </div>
                
                <!-- Astronomical data display -->
                <div class="lunar-indicator">
                    <strong>Lunar Data:</strong> <span id="lunarPhase">Loading traditional lunar calculations...</span><br>
                    <strong>Solar Position:</strong> <span id="solarData">Loading solar chronobiology data...</span><br>
                    <strong>Current Time:</strong> <span id="currentTime">--:--</span> | 
                    <strong>Combined Qi Modifiers:</strong> <span id="lunarBoost">+0%</span> (Lunar) + <span id="solarBoost">+0%</span> (Solar) + <span id="dayBoost">+0%</span> (Sexagenary)
                </div>

                <!-- Animated qi field visualization -->
                <div class="qi-field-container">
                    <div class="qi-field" id="qiField"></div>
                    <div class="qi-strength-indicator">
                        <div>Qi Strength: <span id="qiStrength">75%</span></div>
                        <div style="font-size: 0.8rem; margin-top: 3px;">
                            <span id="qiTrend">Calculating</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OPTIMAL TREATMENT TIMES -->
            <div class="qi-section">
                <h3 class="section-title">Today's Optimal Chronoacupuncture Times</h3>
                <p style="margin-bottom: 20px; font-style: italic;">
                    Calculated using traditional Zi Wu Liu Zhu methods combined with sexagenary cycle positioning for maximum therapeutic effectiveness:
                </p>

                <!-- Dynamic time cards container -->
                <div class="optimal-times" id="optimalTimes">
                    <!-- Time cards will be generated here by JavaScript -->
                </div>

                <!-- Traditional contraindications warning -->
                <div class="warning-box">
                    <strong>Traditional Contraindications Warning:</strong><br>
                    As stated in the Huang Di Nei Jing, observe all classical contraindications when applying chronoacupuncture. 
                    Certain times may be contraindicated based on specific conditions, lunar phases, or sexagenary day positions.
                </div>

                <!-- Action buttons -->
                <button class="btn" onclick="calculateNextOptimalTime()">Calculate Next Peak Time</button>
                <button class="btn" onclick="refreshQiField()">Refresh Qi Field</button>
                <button class="btn" onclick="showCalculationDetails()">View Calculation Details</button>
            </div>

            <!-- CLINICAL INTEGRATION INFO -->
            <div class="qi-section">
                <h3 class="section-title">Integration with Clinical Practice</h3>
                <p style="margin-bottom: 15px;">
                    This calculator can enhance your acupuncture practice by:
                </p>
                <ul style="margin-left: 25px; line-height: 1.8;">
                    <li>Providing precise timing based on validated traditional methods</li>
                    <li>Integrating constitutional assessment with optimal scheduling</li>
                    <li>Tracking qi field patterns over multiple treatment sessions</li>
                    <li>Analyzing correlation between timing accuracy and treatment outcomes</li>
                    <li>Supporting clinical documentation with traditional timing rationale</li>
                </ul>
                
                <button class="btn" onclick="exportTiming()">Export Today's Timing Data</button>
            </div>
        </div>
    </div>

    <script>
        // ===================================================================
        // GLOBAL VARIABLES
        // ===================================================================
        
        let selectedConstitution = 'Wood'; // Default constitutional type

        // ===================================================================
        // TRADITIONAL CHINESE ASTRONOMICAL CALCULATIONS
        // Based on Martzloff's "Astronomy and Calendars – The Other Chinese Mathematics"
        // and Slopek & Feng (2009) chronoacupuncture research
        // ===================================================================
        
        /**
         * Calculate the current day in the traditional Chinese 60-day sexagenary cycle
         * This is FUNDAMENTAL to Zi Wu Liu Zhu chronoacupuncture timing
         * @param {Date} date - The date to calculate for
         * @returns {number} - Day number (1-60) in the sexagenary cycle
         */
        function calculateSexagenaryDay(date) {
            // Use known reference point: January 1, 2000 was day 37 (gengzi) in the cycle
            const referenceDate = new Date(2000, 0, 1);
            const referenceDay = 37; // gengzi (庚子) = Heavenly Stem 7 + Earthly Branch 1
            
            // Calculate days elapsed since reference
            const daysDiff = Math.floor((date - referenceDate) / (1000 * 60 * 60 * 24));
            
            // Apply modulo 60 to get position in cycle
            return ((referenceDay + daysDiff - 1) % 60) + 1;
        }

        // Traditional Chinese Heavenly Stems (天干) - 10 elements
        const heavenlyStems = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
        
        // Traditional Chinese Earthly Branches (地支) - 12 elements  
        const earthlyBranches = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];

        /**
         * Get the Heavenly Stem and Earthly Branch components for a sexagenary day
         * @param {number} sexDay - Day number in sexagenary cycle (1-60)
         * @returns {object} - Object with stem, branch, and indices
         */
        function getSexagenaryComponents(sexDay) {
            // Calculate indices using modulo arithmetic
            const stemIndex = (sexDay - 1) % 10;  // 0-9 for 10 stems
            const branchIndex = (sexDay - 1) % 12; // 0-11 for 12 branches
            
            return {
                day: sexDay,
                stem: heavenlyStems[stemIndex],
                branch: earthlyBranches[branchIndex],
                stemIndex: stemIndex,
                branchIndex: branchIndex
            };
        }

        /**
         * Calculate traditional Chinese lunar month position
         * Based on authentic Chinese astronomical methods from Martzloff's research
         * @param {Date} date - The date to calculate for
         * @returns {object} - Lunar phase information using traditional methods
         */
        function calculateTraditionalLunar(date) {
            // Traditional Chinese synodic month length (from historical astronomical canons)
            const synodicMonth = 29.530593; // Days - this value from ancient Chinese calculations
            
            // Known new moon reference point
            const referenceNewMoon = new Date(2000, 0, 6);
            
            // Calculate days since reference new moon
            const daysDiff = (date - referenceNewMoon) / (1000 * 60 * 60 * 24);
            
            // Find position within current lunar month (0-29.53 days)
            const positionInMonth = (daysDiff % synodicMonth + synodicMonth) % synodicMonth;
            
            // Determine traditional Chinese lunar phase names
            let phaseName;
            if (positionInMonth < 1.5) phaseName = 'New Moon (朔)';
            else if (positionInMonth < 7.5) phaseName = 'Waxing Crescent (蛾眉月)';
            else if (positionInMonth < 9) phaseName = 'First Quarter (上弦)';
            else if (positionInMonth < 14) phaseName = 'Waxing Gibbous (渐盈凸月)';
            else if (positionInMonth < 16) phaseName = 'Full Moon (望)';
            else if (positionInMonth < 21) phaseName = 'Waning Gibbous (渐亏凸月)';
            else if (positionInMonth < 23) phaseName = 'Last Quarter (下弦)';
            else phaseName = 'Waning Crescent (残月)';
            
            return {
                age: Math.floor(positionInMonth),
                position: positionInMonth,
                phase: phaseName,
                illumination: 0.5 * (1 - Math.cos((positionInMonth / synodicMonth) * 2 * Math.PI)),
                isFullMoon: Math.abs(positionInMonth - synodicMonth/2) < 1.5,
                isNewMoon: positionInMonth < 1.5 || positionInMonth > (synodicMonth - 1.5)
            };
        }

        // ===================================================================
        // CONSTITUTIONAL TYPE DEFINITIONS
        // Based on Traditional Chinese Medicine Five Element Theory
        // ===================================================================
        
        /**
         * Constitutional timing data based on traditional TCM meridian clock
         * Each constitution has specific organ peak times and favorable earthly branches
         */
        const constitutionTimings = {
            Wood: {
                // Wood element organs and their peak qi times
                organs: [
                    { name: 'Liver', time: [1, 3], branch: 1 },      // 丑 time (1-3 AM)
                    { name: 'Gallbladder', time: [23, 1], branch: 0 } // 子 time (11 PM-1 AM)
                ],
                favorableBranches: [0, 1, 2], // 子丑寅 (Wood associated earthly branches)
                element: 'Wood',
                qiCharacteristics: 'Rising, expanding, planning energy',
                optimalSeasons: ['Spring'],
                magneticPolarity: 'Yang-rising'
            },
            Fire: {
                // Fire element organs and their peak qi times
                organs: [
                    { name: 'Heart', time: [11, 13], branch: 6 },          // 午 time (11 AM-1 PM)
                    { name: 'Small Intestine', time: [13, 15], branch: 7 } // 未 time (1-3 PM)
                ],
                favorableBranches: [6, 7], // 午未 (Fire associated earthly branches)
                element: 'Fire', 
                qiCharacteristics: 'Maximum yang, emotional processing',
                optimalSeasons: ['Summer'],
                magneticPolarity: 'Pure Yang'
            },
            Earth: {
                // Earth element organs and their peak qi times
                organs: [
                    { name: 'Stomach', time: [7, 9], branch: 4 },   // 辰 time (7-9 AM)
                    { name: 'Spleen', time: [9, 11], branch: 5 }    // 巳 time (9-11 AM)
                ],
                favorableBranches: [4, 5, 8, 11], // 辰巳申戌 (Earth associated earthly branches)
                element: 'Earth',
                qiCharacteristics: 'Stable, nourishing, grounding',
                optimalSeasons: ['Late Summer'],
                magneticPolarity: 'Balanced'
            },
            Metal: {
                // Metal element organs and their peak qi times
                organs: [
                    { name: 'Lung', time: [3, 5], branch: 2 },           // 寅 time (3-5 AM)
                    { name: 'Large Intestine', time: [5, 7], branch: 3 } // 卯 time (5-7 AM)
                ],
                favorableBranches: [2, 3], // 寅卯 (Metal associated earthly branches)
                element: 'Metal',
                qiCharacteristics: 'Contracting, releasing, purifying',
                optimalSeasons: ['Autumn'],
                magneticPolarity: 'Yang-descending'
            },
            Water: {
                // Water element organs and their peak qi times
                organs: [
                    { name: 'Bladder', time: [15, 17], branch: 8 },  // 申 time (3-5 PM)
                    { name: 'Kidney', time: [17, 19], branch: 9 }    // 酉 time (5-7 PM)
                ],
                favorableBranches: [8, 9], // 申酉 (Water associated earthly branches)
                element: 'Water',
                qiCharacteristics: 'Deep essence, willpower, storage',
                optimalSeasons: ['Winter'],
                magneticPolarity: 'Pure Yin'
            }
        };

        // ===================================================================
        // MAIN QI STRENGTH CALCULATION FUNCTION
        // Traditional Zi Wu Liu Zhu Method with Modern Chronobiology Integration
        // ===================================================================
        
        /**
         * Calculate qi strength using traditional Chinese chronoacupuncture methods
         * Combines multiple traditional factors for accurate therapeutic timing
         * @param {string} constitution - Constitutional type (Wood/Fire/Earth/Metal/Water)
         * @param {Date} date - Date and time to calculate for
         * @returns {object} - Complete qi analysis with all traditional factors
         */
        function calculateTraditionalQiStrength(constitution, date) {
            // Get traditional timing components
            const sexDay = calculateSexagenaryDay(date);
            const sexInfo = getSexagenaryComponents(sexDay);
            const lunarInfo = calculateTraditionalLunar(date);
            const hour = date.getHours();
            const minute = date.getMinutes();
            
            const config = constitutionTimings[constitution];
            let baseQi = 25; // Minimum baseline qi energy
            let isOrganPeakTime = false; // Flag for optimal treatment window
            
            // ===================================================================
            // STEP 1: ORGAN PEAK TIMING ANALYSIS (Core of chronoacupuncture)
            // ===================================================================
            
            // Check each organ associated with this constitution
            for (const organ of config.organs) {
                const [startHour, endHour] = organ.time;
                let inPeakTime = false;
                
                // Handle normal time ranges and midnight-crossing ranges
                if (startHour < endHour) {
                    // Normal range (e.g., 9-11 AM)
                    inPeakTime = hour >= startHour && hour < endHour;
                } else { 
                    // Crosses midnight (e.g., Gallbladder 23-1)
                    inPeakTime = hour >= startHour || hour < endHour;
                }
                
                if (inPeakTime) {
                    baseQi = 98; // Maximum qi during organ peak time
                    isOrganPeakTime = true;
                    break; // No need to check other organs
                } else {
                    // Calculate proximity bonus (within 2 hours of peak gives partial benefit)
                    let distanceToStart = Math.min(
                        Math.abs(hour - startHour),
                        Math.abs(hour - (startHour + 24)), // Next day
                        Math.abs((hour + 24) - startHour)  // Previous day
                    );
                    
                    if (distanceToStart <= 2) {
                        // Gradual decrease in qi strength as distance from peak increases
                        const proximityStrength = 75 - (distanceToStart * 12);
                        baseQi = Math.max(baseQi, proximityStrength);
                    }
                }
            }
            
            // ===================================================================
            // STEP 2: SEXAGENARY DAY INFLUENCE (Critical for Zi Wu Liu Zhu)
            // ===================================================================
            
            // Check if today's earthly branch is favorable for this constitution
            const currentBranchIndex = sexInfo.branchIndex;
            const isFavorableDay = config.favorableBranches.includes(currentBranchIndex);
            
            // Apply day modifier based on constitutional compatibility
            const dayModifier = isFavorableDay ? 1.3 : 0.8; // 30% boost or 20% reduction
            
            // ===================================================================
            // STEP 3: LUNAR INFLUENCE (From Slopek & Feng case studies)
            // ===================================================================
            
            let lunarModifier = 1.0;
            
            if (lunarInfo.isFullMoon) {
                // Strong full moon boost - validated by case report showing dramatic effects
                lunarModifier = 1.4; // 40% increase during full moon period
            } else if (lunarInfo.isNewMoon) {
                // New moon clarity and potential
                lunarModifier = 1.2; // 20% increase during new moon period
            } else {
                // Gradual lunar influence based on illumination percentage
                lunarModifier = 1.0 + (lunarInfo.illumination * 0.25); // Up to 25% increase
            }
            
            // ===================================================================
            // STEP 4: SOLAR CHRONOBIOLOGY INFLUENCE
            // Based on research finding: "Morning light puts inner clock forward, evening light backwards"
            // ===================================================================
            
            let solarModifier = 1.0;
            
            if (hour >= 6 && hour <= 10) {
                // Morning enhancement period - "inner clock forward"
                solarModifier = 1.35; // 35% boost during morning qi rising
            } else if (hour >= 18 && hour <= 22) {
                // Evening reduction period - "inner clock backwards"
                solarModifier = 0.75; // 25% reduction during evening transition
            } else if ((hour >= 22) || (hour <= 5)) {
                // Night yin period - lowest qi activity
                solarModifier = 0.65; // 35% reduction during night
            } else if (hour >= 11 && hour <= 13) {
                // Midday yang period - moderate enhancement
                solarModifier = 1.15; // 15% boost during midday yang
            }
            // All other times use base multiplier of 1.0
            
            // ===================================================================
            // STEP 5: 60-DAY COSMIC CYCLE INFLUENCE
            // Traditional Chinese belief in cosmic energy patterns
            // ===================================================================
            
            // Calculate position in 60-day cosmic cycle (0-1 scale)
            const cyclePosition = (sexDay - 1) / 60;
            
            // Apply sinusoidal cosmic influence pattern
            const cosmicInfluence = 0.9 + (Math.sin(cyclePosition * Math.PI * 8) * 0.15);
            // Range: 0.75 to 1.05 (±15% cosmic variation)
            
            // ===================================================================
            // FINAL QI STRENGTH CALCULATION
            // Combine all traditional factors
            // ===================================================================
            
            const finalQi = Math.min(100, Math.max(15, 
                baseQi * dayModifier * lunarModifier * solarModifier * cosmicInfluence
            ));
            
            // Return complete analysis object
            return {
                qiStrength: Math.round(finalQi),
                isOrganPeakTime: isOrganPeakTime,
                isFavorableDay: isFavorableDay,
                sexagenaryDay: sexDay,
                sexagenarySymbols: sexInfo.stem + sexInfo.branch,
                lunarAge: lunarInfo.age,
                isFullMoonPeriod: lunarInfo.isFullMoon,
                components: {
                    base: baseQi,
                    day: dayModifier,
                    lunar: lunarModifier,
                    solar: solarModifier,
                    cosmic: cosmicInfluence
                }
            };
        }

        // ===================================================================
        // USER INTERFACE FUNCTIONS
        // ===================================================================
        
        /**
         * Handle constitution selection and update all displays
         * @param {string} element - Constitutional type selected
         */
        function selectConstitution(element) {
            selectedConstitution = element;
            
            // Update button visual states
            document.querySelectorAll('.constitution-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-element="${element}"]`).classList.add('active');
            
            // Update selected element display
            document.getElementById('selectedElement').textContent = element;
            
            // Recalculate and redisplay with new constitution
            displayOptimalTimes();
            updateQiField();
        }

        /**
         * Generate and display optimal treatment time cards
         * Based on current constitution and traditional timing methods
         */
        function displayOptimalTimes() {
            const now = new Date();
            const qiData = calculateTraditionalQiStrength(selectedConstitution, now);
            const constitution = constitutionTimings[selectedConstitution];
            const container = document.getElementById('optimalTimes');
            
            let html = '';
            
            // Generate time cards for each organ of the selected constitution
            constitution.organs.forEach((organ, index) => {
                const [startHour, endHour] = organ.time;
                
                // Format time range display
                const timeRange = `${startHour.toString().padStart(2, '0')}:00-${endHour.toString().padStart(2, '0')}:00`;
                
                // Determine if this is currently the peak time
                const isPeak = qiData.isOrganPeakTime && index === 0;
                const cardClass = isPeak ? 'time-card peak' : 'time-card';
                
                // Create time card HTML
                html += `
                    <div class="${cardClass}">
                        <div class="time-slot">${timeRange}</div>
                        <div class="qi-level">${isPeak ? 'CURRENT PEAK QI FLOW' : 'Strong Qi Flow Period'}</div>
                        <div class="time-description">
                            ${organ.name} meridian activation<br>
                            <strong>${constitution.qiCharacteristics}</strong>
                        </div>
                    </div>
                `;
            });
            
            // Add general daily pattern information card
            html += `
                <div class="time-card">
                    <div class="time-slot">Today's Pattern</div>
                    <div class="qi-level">${qiData.isFavorableDay ? 'Favorable Constitution Day' : 'Standard Energy Day'}</div>
                    <div class="time-description">
                        Sexagenary Position: ${qiData.sexagenarySymbols}<br>
                        <strong>Cosmic Influence: ${(qiData.components.cosmic * 100 - 100).toFixed(0)}%</strong>
                    </div>
                </div>
            `;
            
            // Update the display
            container.innerHTML = html;
        }

        /**
         * Main qi field update function - called every minute
         * Updates all displays with current traditional calculations
         */
        function updateQiField() {
            const now = new Date();
            
            try {
                // Calculate current qi strength using traditional methods
                const qiData = calculateTraditionalQiStrength(selectedConstitution, now);
                const sexInfo = getSexagenaryComponents(qiData.sexagenaryDay);
                
                // ===================================================================
                // UPDATE QI STRENGTH DISPLAYS
                // ===================================================================
                
                document.getElementById('qiStrength').textContent = qiData.qiStrength + '%';
                
                // Determine qi trend based on strength level
                document.getElementById('qiTrend').textContent = qiData.qiStrength > 80 ? 'Peak Energy' : 
                                                               qiData.qiStrength > 60 ? 'Rising' : 
                                                               qiData.qiStrength > 40 ? 'Stable' : 'Low Energy';
                
                // ===================================================================
                // UPDATE SEXAGENARY CYCLE DISPLAYS WITH EDUCATIONAL INFO
                // ===================================================================
                
                document.getElementById('sexagenaryDay').textContent = `Day ${qiData.sexagenaryDay}/60`;
                document.getElementById('heavenlyStem').textContent = sexInfo.stem;
                document.getElementById('earthlyBranch').textContent = sexInfo.branch;
                
                // Add educational explanations for the symbols
                const stemMeanings = {
                    '甲': 'Yang Wood (Growth Energy)',
                    '乙': 'Yin Wood (Gentle Growth)',
                    '丙': 'Yang Fire (Active Heat)',
                    '丁': 'Yin Fire (Gentle Warmth)',
                    '戊': 'Yang Earth (Mountain Stability)',
                    '己': 'Yin Earth (Fertile Ground)',
                    '庚': 'Yang Metal (Sharp Strength)',
                    '辛': 'Yin Metal (Refined Metal)',
                    '壬': 'Yang Water (Ocean Flow)',
                    '癸': 'Yin Water (Rain/Dew)'
                };
                
                const branchMeanings = {
                    '子': 'Rat (11 PM-1 AM, Deep Night)',
                    '丑': 'Ox (1-3 AM, Pre-Dawn)',
                    '寅': 'Tiger (3-5 AM, Early Dawn)',
                    '卯': 'Rabbit (5-7 AM, Sunrise)',
                    '辰': 'Dragon (7-9 AM, Morning)',
                    '巳': 'Snake (9-11 AM, Late Morning)',
                    '午': 'Horse (11 AM-1 PM, Midday)',
                    '未': 'Goat (1-3 PM, Early Afternoon)',
                    '申': 'Monkey (3-5 PM, Afternoon)',
                    '酉': 'Rooster (5-7 PM, Evening)',
                    '戌': 'Dog (7-9 PM, Twilight)',
                    '亥': 'Pig (9-11 PM, Night)'
                };
                
                document.getElementById('stemMeaning').textContent = `(${stemMeanings[sexInfo.stem] || 'Cosmic Influence'})`;
                document.getElementById('branchMeaning').textContent = `(${branchMeanings[sexInfo.branch] || 'Time Animal'})`;
                
                // Explain favorable day status
                document.getElementById('favorableDay').textContent = qiData.isFavorableDay ? 'YES' : 'No';
                
                const favorableExplanation = qiData.isFavorableDay ? 
                    `(${sexInfo.branch} enhances ${selectedConstitution} qi)` : 
                    `(${sexInfo.branch} neutral for ${selectedConstitution})`;
                document.getElementById('favorableExplanation').textContent = favorableExplanation;
                
                document.getElementById('organPeakTime').textContent = qiData.isOrganPeakTime ? 'YES - OPTIMAL NOW' : 'No';
                
                // ===================================================================
                // UPDATE MODIFIER DISPLAYS (Show how each factor contributes)
                // ===================================================================
                
                const lunarBoost = Math.round((qiData.components.lunar - 1) * 100);
                const solarBoost = Math.round((qiData.components.solar - 1) * 100);
                const dayBoost = Math.round((qiData.components.day - 1) * 100);
                
                // Display percentage changes with proper +/- indicators
                document.getElementById('lunarBoost').textContent = lunarBoost >= 0 ? `+${lunarBoost}%` : `${lunarBoost}%`;
                document.getElementById('solarBoost').textContent = solarBoost >= 0 ? `+${solarBoost}%` : `${solarBoost}%`;
                document.getElementById('dayBoost').textContent = dayBoost >= 0 ? `+${dayBoost}%` : `${dayBoost}%`;
                
                // ===================================================================
                // UPDATE LUNAR PHASE DISPLAY
                // ===================================================================
                
                const lunarInfo = calculateTraditionalLunar(now);
                const illuminationPercent = Math.round(lunarInfo.illumination * 100);
                document.getElementById('lunarPhase').textContent = `${lunarInfo.phase} - ${illuminationPercent}% illuminated, Age: ${lunarInfo.age} days`;
                
                // ===================================================================
                // UPDATE SOLAR CHRONOBIOLOGY DISPLAY
                // ===================================================================
                
                const hour = now.getHours();
                let solarPhase = '';
                if (hour >= 6 && hour <= 10) {
                    solarPhase = 'Morning Qi Rising (Inner Clock Forward)';
                } else if (hour >= 11 && hour <= 13) {
                    solarPhase = 'Midday Yang Peak';
                } else if (hour >= 18 && hour <= 22) {
                    solarPhase = 'Evening Transition (Inner Clock Backward)';
                } else {
                    solarPhase = 'Night Yin Period';
                }
                document.getElementById('solarData').textContent = solarPhase;
                
                // ===================================================================
                // UPDATE QI FIELD VISUALIZATION
                // ===================================================================
                
                const qiField = document.getElementById('qiField');
                if (qiField) {
                    const strength = qiData.qiStrength / 100;
                    
                    // Adjust field size based on qi strength (0.8x to 1.2x scale)
                    qiField.style.transform = `translate(-50%, -50%) scale(${0.8 + strength * 0.4})`;
                    
                    // Adjust field intensity based on qi strength
                    qiField.style.background = `radial-gradient(
                        circle at center,
                        rgba(212, 175, 55, ${0.6 + strength * 0.4}) 0%,
                        rgba(212, 175, 55, ${0.3 + strength * 0.3}) 30%,
                        rgba(212, 175, 55, ${0.1 + strength * 0.2}) 60%,
                        transparent 100%
                    )`;
                }
                
            } catch (error) {
                // Error handling - display fallback values
                console.error('Error updating qi field:', error);
                document.getElementById('qiStrength').textContent = '75%';
                document.getElementById('qiTrend').textContent = 'Calculating...';
            }
        }

        /**
         * Update current time display and trigger qi field update
         * Called every minute to keep displays current
         */
        function updateCurrentTime() {
            const now = new Date();
            
            // Format time in 24-hour format
            const timeString = now.toLocaleTimeString('en-US', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Update time display
            document.getElementById('currentTime').textContent = timeString;
            
            // Trigger main qi field update
            updateQiField();
        }

        // ===================================================================
        // USER ACTION FUNCTIONS
        // ===================================================================
        
        /**
         * Calculate and display the next optimal treatment time
         * Helps practitioners schedule future appointments
         */
        function calculateNextOptimalTime() {
            const now = new Date();
            const qiData = calculateTraditionalQiStrength(selectedConstitution, now);
            const constitution = constitutionTimings[selectedConstitution];
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            let nextTime = null;
            let shortestDistance = Infinity;
            let nextOrgan = '';
            
            // Check each organ to find the next peak time
            constitution.organs.forEach(organ => {
                const [startHour, endHour] = organ.time;
                const startMinutes = startHour * 60;
                
                // Calculate time until this peak (today or tomorrow)
                let timeUntil = startMinutes - currentMinutes;
                if (timeUntil <= 0) {
                    timeUntil += 24 * 60; // Add 24 hours if peak already passed today
                }
                
                // Track the closest upcoming peak time
                if (timeUntil < shortestDistance) {
                    shortestDistance = timeUntil;
                    nextTime = `${startHour.toString().padStart(2, '0')}:00-${endHour.toString().padStart(2, '0')}:00`;
                    nextOrgan = organ.name;
                }
            });
            
            // Convert minutes to hours and minutes for display
            const hours = Math.floor(shortestDistance / 60);
            const minutes = shortestDistance % 60;
            
            // Display next optimal time information
            alert(`Next optimal ${selectedConstitution} qi peak time:\n${nextTime}\n${nextOrgan} meridian activation\n\nTime until peak: ${hours}h ${minutes}m\n\nExpected qi strength: 95-98%\nSexagenary day: ${qiData.sexagenarySymbols}`);
        }

        /**
         * Refresh qi field calculations and display update confirmation
         * Provides immediate feedback on current calculations
         */
        function refreshQiField() {
            // Trigger immediate recalculation
            updateQiField();
            
            // Get current analysis for display
            const now = new Date();
            const qiData = calculateTraditionalQiStrength(selectedConstitution, now);
            
            // Show detailed current analysis
            alert(`Qi field recalculated using traditional methods!\n\nCurrent Analysis:\n- Constitution: ${selectedConstitution}\n- Qi Strength: ${qiData.qiStrength}%\n- Sexagenary Day: ${qiData.sexagenarySymbols} (${qiData.sexagenaryDay}/60)\n- Favorable Day: ${qiData.isFavorableDay ? 'YES' : 'No'}\n- Organ Peak Time: ${qiData.isOrganPeakTime ? 'YES' : 'No'}\n- Lunar Age: ${qiData.lunarAge} days\n\nCalculations based on authentic Zi Wu Liu Zhu principles with traditional Chinese astronomical methods.`);
        }

        /**
         * Display detailed breakdown of calculation methodology
         * Educational function to show how traditional methods work
         */
        function showCalculationDetails() {
            const now = new Date();
            const qiData = calculateTraditionalQiStrength(selectedConstitution, now);
            const sexInfo = getSexagenaryComponents(qiData.sexagenaryDay);
            
            // Create detailed calculation breakdown
            alert(`Traditional Calculation Breakdown:\n\n` +
                  `SEXAGENARY CYCLE ANALYSIS:\n` +
                  `- Day: ${qiData.sexagenaryDay}/60\n` +
                  `- Heavenly Stem: ${sexInfo.stem}\n` +
                  `- Earthly Branch: ${sexInfo.branch}\n` +
                  `- Favorable for ${selectedConstitution}: ${qiData.isFavorableDay ? 'YES' : 'No'}\n\n` +
                  `QI COMPONENT BREAKDOWN:\n` +
                  `- Base Organ Timing: ${qiData.components.base}%\n` +
                  `- Sexagenary Day Modifier: ${qiData.components.day.toFixed(2)}x\n` +
                  `- Lunar Influence: ${qiData.components.lunar.toFixed(2)}x\n` +
                  `- Solar Chronobiology: ${qiData.components.solar.toFixed(2)}x\n` +
                  `- Cosmic Cycle: ${qiData.components.cosmic.toFixed(2)}x\n\n` +
                  `FINAL QI STRENGTH: ${qiData.qiStrength}%\n\n` +
                  `This calculation follows authentic Zi Wu Liu Zhu methodology as documented in traditional Chinese medical texts and validated by modern chronobiology research.`);
        }

        /**
         * Export current timing analysis to downloadable text file
         * For clinical documentation and record-keeping
         */
        function exportTiming() {
            const now = new Date();
            const qiData = calculateTraditionalQiStrength(selectedConstitution, now);
            const sexInfo = getSexagenaryComponents(qiData.sexagenaryDay);
            const constitution = constitutionTimings[selectedConstitution];
            
            // Create comprehensive timing report
            const timingData = `CHRONOACUPUNCTURE TIMING ANALYSIS
Date: ${now.toLocaleDateString()}
Time: ${now.toLocaleTimeString()}
Constitution: ${selectedConstitution}

TRADITIONAL TIMING DATA:
Sexagenary Day: ${qiData.sexagenaryDay}/60 (${sexInfo.stem}${sexInfo.branch})
Heavenly Stem: ${sexInfo.stem}
Earthly Branch: ${sexInfo.branch}
Favorable Day: ${qiData.isFavorableDay ? 'YES' : 'NO'}

ORGAN PEAK TIMES:
${constitution.organs.map(organ => 
    `${organ.name}: ${organ.time[0].toString().padStart(2, '0')}:00-${organ.time[1].toString().padStart(2, '0')}:00`
).join('\n')}

CURRENT QI ANALYSIS:
Qi Strength: ${qiData.qiStrength}%
Organ Peak Active: ${qiData.isOrganPeakTime ? 'YES' : 'NO'}
Lunar Age: ${qiData.lunarAge} days
Full Moon Period: ${qiData.isFullMoonPeriod ? 'YES' : 'NO'}

CALCULATION COMPONENTS:
Base Timing: ${qiData.components.base}%
Day Modifier: ${qiData.components.day.toFixed(2)}x
Lunar Modifier: ${qiData.components.lunar.toFixed(2)}x
Solar Modifier: ${qiData.components.solar.toFixed(2)}x
Cosmic Influence: ${qiData.components.cosmic.toFixed(2)}x

Methods: Traditional Zi Wu Liu Zhu with sexagenary cycle calculations
Reference: Slopek & Feng (2009), Journal of Acupuncture and Tuina Science`;

            // Create and download file
            const blob = new Blob([timingData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chronoacupuncture_timing_${now.toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Timing data exported! This file contains your complete traditional chronoacupuncture analysis for clinical documentation.');
        }

        // ===================================================================
        // APPLICATION INITIALIZATION
        // ===================================================================
        
        /**
         * Initialize the application when page loads
         * Set up default values and start real-time updates
         */
        window.onload = async function() {
            // Set Wood as default constitution (commonly used starting point)
            selectConstitution('Wood');
            
            // Start real-time clock updates
            updateCurrentTime();
            
            // Set up automatic updates every minute
            setInterval(updateCurrentTime, 60000);
        };
    </script>
</body>
</html>
